# 合同审查小助手 - 设计框架文档

## 项目概述

开发一个"合同审查小助手"桌面软件，注重**易用性**、**模块化**以及**本地化扩展能力**，满足法律行业对隐私和准确性的极高要求。

---

## 一、软件架构设计

### 1.1 整体架构

采用**前后端分离**的本地架构，保证可扩展性。

```
┌─────────────────────────────────────────────────────────┐
│                     用户界面层                            │
│                   (PyQt6 / Electron)                     │
│            简洁仪表盘 | 拖拽上传 | 进度显示                │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                    业务逻辑层                             │
│        文件解析 | 任务分发 | 提示词拼接 | 流程控制          │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                     AI 适配层                             │
│     OpenAI/DeepSeek API | 本地 Ollama (Llama3/Qwen2)    │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                    存储/导出层                            │
│        缓存审查记录 | 导出 Word/PDF/Markdown              │
└─────────────────────────────────────────────────────────┘
```

### 1.2 架构说明

| 层级 | 技术选型 | 职责描述 |
|:---|:---|:---|
| **前端 (UI层)** | PyQt6 / Electron | 提供简洁的仪表盘，支持拖拽上传合同文件 |
| **业务逻辑层** | Python | 处理文件解析（PDF/Word转文本）、任务分发、提示词拼接 |
| **AI 适配层** | 统一接口封装 | 支持切换 OpenAI/DeepSeek API 或本地 Ollama |
| **存储/导出层** | 本地文件系统 | 缓存审查记录，支持导出为 Word、PDF 或 Markdown |

---

## 二、核心功能模块

### 2.1 功能模块图

```
用户上传合同
     ↓
┌─────────────────────────────────────┐
│    模块 1: 预处理与要点细化          │
│  • 输入简单要求                      │
│  • LLM 1 转化为结构化审查清单        │
│  • 生成《审查清单》                  │
└─────────────────────────────────────┘
     ↓
┌─────────────────────────────────────┐
│    模块 2: 深度审查                 │
│  • 结合 Lawyer 提示词               │
│  • 逐项扫描合同全文                 │
│  • 生成分析结果                     │
└─────────────────────────────────────┘
     ↓
┌─────────────────────────────────────┐
│    模块 3: 文档生成                 │
│  • 问题-风险-建议-修改后条款         │
│  • 排版生成对比文档                 │
│  • 导出多种格式                     │
└─────────────────────────────────────┘
```

### 2.2 模块详细说明

#### 模块 1: 预处理与要点细化 (Step 1)

**功能描述：** 将用户要求转化为审查点

**输入：**
- 用户上传的合同文件
- 用户输入的简单要求（如"我是乙方,重点看回款周期"）

**处理逻辑：**
- 调用 LLM 1（需求分析员/任务细化专家）
- 将模糊要求转化为结构化的《审查清单》

**输出：**
- 结构化审查清单（JSON 格式）
- 包含合同维度和具体审查点

---

#### 模块 2: 深度审查 (Step 2)

**功能描述：** 对合同进行全面审查

**处理逻辑：**
- 利用 Lawyer 提示词
- 结合 Step 1 生成的清单
- 对合同全文进行逐项扫描

**审查维度：**
- 合规性审查
- 风险识别
- 条款公平性分析
- 利益保护评估

---

#### 模块 3: 文档生成 (Step 3)

**功能描述：** 生成专业的审查报告

**输出格式：**
- 问题描述
- 风险分析
- 修改建议
- 修改后条款
- 原文与建议对比表

**支持导出格式：**
- Word (.docx)
- PDF (.pdf)
- Markdown (.md)

---

## 三、提示词工程

### 3.1 提示词架构

```
用户输入
    ↓
┌─────────────────────────────┐
│   提示词 A: 任务细化专家     │
│   (The Planner)             │
│   将白话需求 → 审查清单      │
└─────────────────────────────┘
    ↓
生成结构化审查清单
    ↓
┌─────────────────────────────┐
│   提示词 B: 合同审查律师     │
│   (The Reviewer)            │
│   结合清单 → 深度审查        │
└─────────────────────────────┘
    ↓
输出审查报告
```

### 3.2 提示词 A：任务细化专家 (The Planner)

#### 用途
将用户的简单想法转化为具体的审查颗粒度

#### 提示词内容

```markdown
## Role: 资深法务专家
## Task: 审查需求转化
## Input:
1. 客户基本身份 (甲/乙方)
2. 合同类型 (如：劳动合同、采购合同)
3. 客户关注点 (如：我担心付款时间太长)

## Workflow:
1. 分析客户身份及其核心利益诉求。
2. 针对该合同类型，列出5-8个必须审查的标准维度（如：主体资格、违约责任、争议管辖等）。
3. 将客户的"关注点"转化为具体的法律审查动作。

## Output Format (JSON):
{
  "contract_focus": ["维度1", "维度2"],
  "specific_checks": [
    {"point": "具体审查点名称", "logic": "审查逻辑描述"}
  ]
}
```

#### 输入参数
| 参数 | 说明 | 示例 |
|:---|:---|:---|
| `client_role` | 客户基本身份 | "乙方" |
| `contract_type` | 合同类型 | "劳动合同" |
| `user_concerns` | 用户关注点 | "担心付款时间太长" |

#### 输出格式
```json
{
  "contract_focus": ["主体资格", "违约责任", "争议管辖", "付款条款"],
  "specific_checks": [
    {
      "point": "付款周期审查",
      "logic": "检查付款周期是否合理，是否存在预付款风险"
    },
    {
      "point": "违约责任均衡性",
      "logic": "对比甲乙双方违约责任是否对等"
    }
  ]
}
```

---

### 3.3 提示词 B：合同审查律师 (The Reviewer)

#### 用途
针对具体内容进行深度审查

#### 提示词内容

```markdown
## Role: 资深执业律师
## Profile: 你擅长识别合同陷阱，保护客户利益，语言专业严谨。

## Context:
- 客户身份: {{client_role}}
- 审查重点清单: {{checklist_from_step_A}}

## Goals:
- 严格依据中国现行法律（民法典等）进行合规性审查。
- 重点识别对客户不利的"不平等条约"。
- 提供可直接复制替换的修改建议条款。

## Workflows:
1. 扫描合同全文。
2. 对照 {{checklist_from_step_A}} 逐条核对。
3. 按照"发现问题 -> 风险分析 -> 修改建议 -> 修改后条款"输出。

## Output (Markdown):
### 一、 核心风险提示
- 风险点1: {具体条款引用}
- 风险分析: {解释为什么不利}

### 二、 修改方案对比
| 原条款内容 | 修改建议 | 修改后建议文本 |
| :--- | :--- | :--- |
| {{原文}} | {{理由}} | {{建议文本}} |
```

#### 输入参数
| 参数 | 说明 | 来源 |
|:---|:---|:---|
| `client_role` | 客户身份 | 用户输入 |
| `checklist_from_step_A` | 审查清单 | 提示词 A 生成 |
| `contract_text` | 合同全文 | 文件解析 |

#### 输出格式
```markdown
### 一、 核心风险提示

#### 风险点 1: 付款周期过长
- **条款引用:** 第三条第 2 款
- **风险分析:** 约定验收后 90 天付款，远超行业 30 天标准，增加乙方资金压力

### 二、 修改方案对比

| 原条款内容 | 修改建议 | 修改后建议文本 |
|:---|:---|:---|
| 甲方应在验收合格后 90 日内支付款项 | 缩短付款周期，符合行业惯例 | 甲方应在验收合格后 30 日内支付款项 |
```

---

## 四、技术栈推荐

### 4.1 技术栈总览

| 模块 | 推荐工具 | 版本/说明 | 理由 |
|:---|:---|:---|:---|
| **界面开发** | PySide6 | Python 6.x | 与 AI 逻辑集成最快，支持跨平台 |
| **文档解析** | python-docx | - | 处理 .docx 的行业标准 |
|  | PyMuPDF | - | 处理 .pdf 的行业标准 |
| **大模型框架** | LangChain | - | 方便处理"多步分析"逻辑 |
|  | LangGraph | - | 支持复杂的流程编排 |
| **本地模型** | Ollama | Qwen2.5-7B-Instruct | 中文法律理解能力极强，保护隐私 |
| **报告生成** | Docxtpl | - | 根据模板生成精美法律意见书 |

### 4.2 技术栈架构图

```
┌──────────────────────────────────────────┐
│           PySide6 (UI 界面)               │
│  • 文件拖拽上传                           │
│  • 实时进度显示                           │
│  • 结果对比展示                           │
└──────────────────────────────────────────┘
                  ↓
┌──────────────────────────────────────────┐
│        LangChain/LangGraph (编排)         │
│  • 提示词 A (任务细化)                    │
│  • 提示词 B (深度审查)                    │
│  • 多步骤流程控制                         │
└──────────────────────────────────────────┘
                  ↓
┌──────────────────────────────────────────┐
│       python-docx / PyMuPDF              │
│  • Word 文档解析                          │
│  • PDF 文档解析                           │
│  • 文本提取与分段                         │
└──────────────────────────────────────────┘
                  ↓
┌──────────────────────────────────────────┐
│    Ollama (本地) / Cloud API (远程)      │
│  • Qwen2.5-7B-Instruct                   │
│  • OpenAI GPT-4                          │
│  • DeepSeek                              │
└──────────────────────────────────────────┘
                  ↓
┌──────────────────────────────────────────┐
│            Docxtpl (报告生成)             │
│  • Word 模板渲染                          │
│  • 格式化输出                             │
│  • PDF 导出                               │
└──────────────────────────────────────────┘
```

---

## 五、关键业务流设计

### 5.1 完整业务流程

```
┌──────────────┐
│  用户启动软件  │
└──────┬───────┘
       ↓
┌──────────────┐
│ 拖拽上传合同  │
└──────┬───────┘
       ↓
┌──────────────┐     ┌──────────────────┐
│ 文件解析      │ ──→ │ 文本提取与结构化  │
│ PDF/Word     │     │ • 分段处理        │
└──────┬───────┘     │ • 条款识别        │
       ↓             └──────────────────┘
┌──────────────┐              ↓
│ 用户输入需求  │     ┌──────────────────┐
│ • 选择身份    │ ──→ │ LLM 1: 任务细化  │
│ • 关注点      │     │ 生成审查清单      │
└──────┬───────┘     └──────────────────┘
       ↓                    ↓
┌──────────────┐     ┌──────────────────┐
│ 交互确认      │ ←── │ 显示 AI 建议清单  │
│ • 勾选审查点  │     │ 用户可增删        │
│ • 添加要求    │     └──────────────────┘
└──────┬───────┘
       ↓
┌──────────────┐     ┌──────────────────┐
│ 开始审查      │ ──→ │ LLM 2: 深度审查  │
│ • 实时进度    │     │ 逐项扫描分析      │
└──────┬───────┘     └──────────────────┘
       ↓                    ↓
┌──────────────┐     ┌──────────────────┐
│ 结果展示      │ ←── │ 生成审查报告      │
│ • 双栏对比    │     │ • 风险标注        │
│ • 批注显示    │     │ • 修改建议        │
└──────┬───────┘     └──────────────────┘
       ↓
┌──────────────┐
│ 导出文档      │
│ • Word       │
│ • PDF        │
│ • Markdown   │
└──────────────┘
```

### 5.2 详细步骤说明

#### 步骤 1: 文件读取与解析
- 软件读取 Word/PDF 文档
- 将文本切分为"通用条款"和"核心条款"
- 识别章节结构（条款编号、标题）

#### 步骤 2: 交互确认
- UI 弹窗显示"AI 建议的审查要点"
- 用户可以：
  - 勾选/取消审查点
  - 添加自定义关注点（如"知识产权保护"）
  - 调整审查深度

#### 步骤 3: 流式审查
- 点击开始审查
- 前端显示 AI 正在审查的进度条
- 实时显示当前审查的条款
- 支持暂停/继续/取消

#### 步骤 4: 结果对比
- 左右双栏显示：
  - **左侧：** 原合同内容
  - **右侧：** AI 的批注和修改建议
- 支持点击跳转到对应条款
- 高亮显示风险点

---

## 六、数据流设计

### 6.1 数据流向图

```
用户输入 (合同 + 需求)
    ↓
┌─────────────────────┐
│   数据标准化层       │
│  • 文本提取          │
│  • 结构化处理        │
└─────────┬───────────┘
          ↓
┌─────────────────────┐
│   提示词组装层       │
│  • 注入用户需求      │
│  • 注入审查清单      │
└─────────┬───────────┘
          ↓
┌─────────────────────┐
│   AI 处理层          │
│  • LLM 1: 任务细化   │
│  • LLM 2: 深度审查   │
└─────────┬───────────┘
          ↓
┌─────────────────────┐
│   结果处理层         │
│  • 格式化输出        │
│  • 对比生成          │
└─────────┬───────────┘
          ↓
    输出 (审查报告)
```

### 6.2 数据结构定义

#### 输入数据结构
```python
{
    "contract_file": "path/to/contract.docx",
    "client_info": {
        "role": "乙方",
        "industry": "软件开发"
    },
    "user_concerns": "关注付款周期和知识产权保护"
}
```

#### 中间数据结构 (LLM 1 输出)
```python
{
    "contract_focus": [
        "主体资格",
        "付款条款",
        "知识产权",
        "违约责任"
    ],
    "specific_checks": [
        {
            "point": "付款周期审查",
            "logic": "检查付款周期是否超过 60 天"
        },
        {
            "point": "知识产权归属",
            "logic": "确认开发成果的知识产权归属"
        }
    ]
}
```

#### 输出数据结构 (LLM 2 输出)
```python
{
    "risks": [
        {
            "title": "付款周期过长",
            "clause_ref": "第三条第 2 款",
            "risk_level": "高",
            "analysis": "约定验收后 90 天付款，远超行业标准",
            "suggestion": {
                "original": "甲方应在验收合格后 90 日内支付款项",
                "reason": "缩短付款周期，符合行业 30 天惯例",
                "revised": "甲方应在验收合格后 30 日内支付款项"
            }
        }
    ]
}
```

---

## 七、项目实施计划

### 7.1 分阶段实施

```
阶段 1: 基础框架搭建
├── 搭建 PyQt 基础界面
├── 实现文件拖拽上传
├── 集成 Ollama 本地模型
└── 测试基本的文件解析功能

阶段 2: 核心功能开发
├── 实现提示词 A (任务细化)
├── 实现提示词 B (深度审查)
├── 开发 LangChain 工作流
└── 实现审查报告生成

阶段 3: 用户体验优化
├── 添加实时进度显示
├── 实现双栏对比视图
├── 支持导出多种格式
└── 添加历史记录功能

阶段 4: 高级功能
├── 支持批量审查
├── 添加审查模板库
├── 实现云端 API 备选
└── 添加使用统计与分析
```

### 7.2 下一步行动建议

#### 第一步：测试提示词 A
- 编写 Python 脚本
- 测试能否准确将"白话"转为"法律审查点"
- 验证 JSON 输出格式的稳定性

#### 第二步：文档解析测试
- 使用 `python-docx` 提取合同特定段落
- 测试不同格式文档的兼容性
- 验证文本提取的准确性

#### 第三步：UI 原型开发
- 搭建简单 PyQt 窗口
- 实现文件拖拽上传功能
- 设计基本的交互流程

---

## 八、核心优势

### 8.1 设计优势

| 优势 | 说明 |
|:---|:---|
| **隐私保护** | 支持本地模型，数据不上传 |
| **模块化** | 各层解耦，易于维护和扩展 |
| **多模型支持** | 可在本地/云端模型间切换 |
| **专业化** | 针对法律场景优化的提示词 |
| **易用性** | 简单输入 → 专业报告 |

### 8.2 适用场景

- 个人律师/法务：提高审查效率
- 中小企业：降低法律成本
- 法律服务平台：批量合同审查
- 法律教育：辅助教学案例分析

---

## 九、风险与挑战

### 9.1 技术风险

| 风险 | 应对策略 |
|:---|:---|
| 本地模型性能不足 | 提供云端 API 备选方案 |
| 文档格式兼容性 | 测试多种格式，添加预处理 |
| AI 输出不稳定 | 使用结构化输出，添加验证层 |
| 复杂合同处理困难 | 支持分段审查，人工干预 |

### 9.2 业务风险

| 风险 | 应对策略 |
|:---|:---|
| 审查准确性 | 添加免责声明，建议复核 |
| 法律责任 | 明确定位为辅助工具 |
| 用户信任度 | 提供风险依据引用，可解释性 |

---

## 十、扩展性设计

### 10.1 功能扩展点

- **多语言支持：** 扩展至英文、日文合同审查
- **模板库：** 预设各类合同的标准审查清单
- **协作功能：** 支持团队共享审查记录
- **AI 模型微调：** 基于用户反馈优化模型
- **API 接口：** 提供编程接口，集成到其他系统

### 10.2 技术扩展点

- **知识库集成：** 对接法律法规数据库
- **OCR 功能：** 支持扫描件识别
- **版本对比：** 支持合同修订版对比
- **区块链存证：** 关键审查记录上链

---

## 附录

### A. 参考资源

- [PySide6 官方文档](https://doc.qt.io/qtforpython/)
- [LangChain 文档](https://python.langchain.com/)
- [Ollama 文档](https://ollama.ai/)
- [python-docx 使用指南](https://python-docx.readthedocs.io/)

### B. 法律参考

- 《中华人民共和国民法典》
- 《中华人民共和国劳动合同法》
- 《中华人民共和国合同法》相关司法解释

### C. 版本历史

| 版本 | 日期 | 说明 |
|:---|:---|:---|
| v1.0 | 2025-01-17 | 初始设计框架 |

---

**文档结束**
